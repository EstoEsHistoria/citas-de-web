<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Citas APA Universal</title>
    <!-- Metadato de autor para esta página -->
    <meta name="author" content="Esto Es Historia">
    <!-- Metadato de año de creación para esta página -->
    <meta name="creation_year" content="2025">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Fuente Inter */
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(to right bottom, #e0f2fe, #bfdbfe); /* Degradado suave de fondo */
        }
        /* Estilos para el área de texto de la cita generada */
        #citationOutput, #inTextCitationOutput {
            white-space: pre-wrap; /* Mantiene los saltos de línea y espacios */
            word-wrap: break-word; /* Rompe palabras largas para evitar desbordamiento */
            user-select: all; /* Permite seleccionar todo el texto fácilmente */
            min-height: 100px; /* Aumenta la altura mínima para visibilidad */
            text-align: left; /* Alinea el texto a la izquierda para APA */
            display: block; /* Asegura que se comporte como un elemento de bloque para el flujo de texto adecuado */
            padding-left: 2.5em; /* Sangría para todas las líneas excepto la primera */
            text-indent: -2.5em; /* Mueve la primera línea hacia atrás (sangría francesa) */
            font-size: 0.95rem; /* Ligeramente más grande */
            line-height: 1.5;
            color: #374151; /* Color de texto más oscuro */
            background-color: #f9fafb; /* Fondo muy claro */
            border: 1px solid #e5e7eb; /* Borde sutil */
            border-radius: 0.75rem; /* Bordes más redondeados */
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05); /* Sombra interna sutil */
        }
        /* Mensajes de alerta */
        #messageBox {
            font-weight: 500;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            text-align: center;
        }
        .text-red-600 {
            color: #dc2626; /* Rojo más vibrante */
        }
        .text-gray-600 {
            color: #4b5563; /* Gris más oscuro para mejor contraste */
        }
        .text-gray-700 {
            color: #374151; /* Gris oscuro para etiquetas */
        }
        .text-gray-800 {
            color: #1f2937; /* Gris muy oscuro para títulos */
        }

        /* Mejoras para el contenedor principal */
        .main-container {
            background-color: #ffffff;
            padding: 2.5rem; /* Más padding */
            border-radius: 1.5rem; /* Más redondeado */
            box-shadow: 0 10px 25px rgba(0,0,0,0.1), 0 5px 10px rgba(0,0,0,0.05); /* Sombra más pronunciada */
            max-width: 600px; /* Ancho máximo para desktop */
            width: 100%;
            box-sizing: border-box; /* Asegura que padding no aumente el ancho */
        }

        /* Inputs mejorados */
        input[type="text"],
        input[type="date"],
        input[type="url"],
        input[type="number"],
        select,
        textarea {
            padding: 0.75rem 1rem; /* Más padding interno */
            border: 1px solid #d1d5db; /* Borde más definido */
            border-radius: 0.5rem; /* Bordes redondeados */
            transition: all 0.2s ease-in-out; /* Transición suave */
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.03); /* Sombra interna */
        }
        input[type="text"]:focus,
        input[type="date"]:focus,
        input[type="url"]:focus,
        input[type="number"]:focus,
        select:focus,
        textarea:focus {
            border-color: #60a5fa; /* Borde azul al enfocar */
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.3); /* Anillo de enfoque azul */
            outline: none; /* Eliminar el contorno por defecto */
        }

        /* Botones mejorados */
        button {
            font-weight: 600; /* Semi-bold */
            padding: 0.85rem 1.5rem; /* Más padding */
            border-radius: 0.75rem; /* Más redondeado */
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); /* Sombra sutil */
        }
        button:hover {
            transform: translateY(-2px); /* Efecto de "levantamiento" al pasar el ratón */
            box-shadow: 0 6px 10px rgba(0,0,0,0.15); /* Sombra más grande al pasar el ratón */
        }
        #generateCitationBtn, #generateInTextCitationBtn {
            background: linear-gradient(to right, #3b82f6, #2563eb); /* Degradado azul */
            color: white;
        }
        #generateCitationBtn:hover, #generateInTextCitationBtn:hover {
            background: linear-gradient(to right, #2563eb, #1d4ed8); /* Degradado más oscuro */
        }
        #copyCitationBtn, #copyInTextCitationBtn {
            background: linear-gradient(to right, #10b981, #059669); /* Degradado verde */
            color: white;
        }
        #copyCitationBtn:hover, #copyInTextCitationBtn:hover {
            background: linear-gradient(to right, #059669, #047857); /* Degradado más oscuro */
        }

        /* Responsividad general */
        @media (max-width: 768px) {
            .main-container {
                padding: 1.5rem; /* Menos padding en móviles */
                border-radius: 1rem; /* Menos redondeado en móviles */
            }
            h1 {
                font-size: 2rem; /* Título más pequeño en móviles */
            }
            p {
                font-size: 0.9rem; /* Texto más pequeño en móviles */
            }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div class="main-container">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Generador de Citas APA Universal</h1>
        <p class="text-gray-600 text-center mb-8">Introduce los detalles del documento para generar la cita en formato APA (7ª edición).</p>

        <div class="space-y-4">
            <div>
                <label for="documentType" class="block text-gray-700 text-sm font-semibold mb-2">Tipo de Documento:</label>
                <select id="documentType" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="website">Página Web</option>
                    <option value="book">Libro</option>
                    <option value="journalArticle">Publicación o Artículo</option>
                </select>
            </div>

            <div id="commonFields" class="space-y-4">
                <div>
                    <label for="authorName" class="block text-gray-700 text-sm font-semibold mb-2">Autor(es) - Apellido, Iniciales. (separa con punto y coma para múltiples autores):</label>
                    <input type="text" id="authorName" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ej: García, M. o García Manuel; Pérez, J.">
                </div>
            </div>

            <!-- Campos específicos para Página Web -->
            <div id="websiteFields" class="space-y-4">
                <div>
                    <label for="publicationDateWebsite" class="block text-gray-700 text-sm font-semibold mb-2">Fecha de Publicación (completa, si disponible):</label>
                    <input type="date" id="publicationDateWebsite" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label for="articleTitle" class="block text-gray-700 text-sm font-semibold mb-2">Título del Artículo / Documento:</label>
                    <input type="text" id="articleTitle" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ej: ¿Qué es civilización? Parte 1 - Civilización y cultura">
                </div>
                <div>
                    <label for="websiteName" class="block text-gray-700 text-sm font-semibold mb-2">Nombre del Sitio Web:</label>
                    <input type="text" id="websiteName" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ej: Wikipedia, BBC News, Esto Es Historia">
                </div>
                <div>
                    <label for="pageUrl" class="block text-gray-700 text-sm font-semibold mb-2">URL de la Página:</label>
                    <input type="url" id="pageUrl" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-2 focus:ring-blue-500" placeholder="Ej: https://ejemplo.com/articulo">
                </div>
            </div>

            <!-- Campos específicos para Libro -->
            <div id="bookFields" class="space-y-4 hidden">
                <div>
                    <label for="publicationYearBook" class="block text-gray-700 text-sm font-semibold mb-2">Año de Publicación:</label>
                    <input type="number" id="publicationYearBook" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ej: 2023 (obligatorio)">
                </div>
                <div>
                    <label for="bookTitle" class="block text-gray-700 text-sm font-semibold mb-2">Título del Libro:</label>
                    <input type="text" id="bookTitle" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ej: El Quijote de la Mancha">
                </div>
                <div>
                    <label for="publisher" class="block text-gray-700 text-sm font-semibold mb-2">Editorial:</label>
                    <input type="text" id="publisher" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ej: Penguin Random House">
                </div>
                <div>
                    <label for="isbn" class="block text-gray-700 text-sm font-semibold mb-2">ISBN (opcional):</label>
                    <input type="text" id="isbn" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ej: 978-3-16-148410-0">
                </div>
            </div>

            <!-- Campos específicos para Publicación o Artículo (anteriormente Artículo de Revista) -->
            <div id="journalArticleFields" class="space-y-4 hidden">
                <div>
                    <label for="publicationYearJournal" class="block text-gray-700 text-sm font-semibold mb-2">Año de Publicación:</label>
                    <input type="number" id="publicationYearJournal" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ej: 2023 (obligatorio)">
                </div>
                <div>
                    <label for="journalArticleTitle" class="block text-gray-700 text-sm font-semibold mb-2">Título del Artículo:</label>
                    <input type="text" id="journalArticleTitle" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ej: El impacto de la IA en la sociedad moderna">
                </div>
                <div>
                    <label for="journalName" class="block text-gray-700 text-sm font-semibold mb-2">Nombre de la Publicación/Revista:</label>
                    <input type="text" id="journalName" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ej: Nature, Communications Earth & Environment">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="journalVolume" class="block text-gray-700 text-sm font-semibold mb-2">Volumen (opcional):</label>
                        <input type="text" id="journalVolume" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ej: 15">
                    </div>
                    <div>
                        <label for="journalIssue" class="block text-gray-700 text-sm font-semibold mb-2">Número (opcional):</label>
                        <input type="text" id="journalIssue" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ej: 3">
                    </div>
                </div>
                <div>
                    <label for="pageRange" class="block text-gray-700 text-sm font-semibold mb-2">Rango de Páginas (opcional):</label>
                    <input type="text" id="pageRange" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ej: 123-145">
                </div>
                <div>
                    <label for="doi" class="block text-gray-700 text-sm font-semibold mb-2">DOI (opcional):</label>
                    <input type="text" id="doi" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ej: 10.1037/a0028240">
                </div>
            </div>

            <button id="generateCitationBtn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-md hover:bg-blue-700 transition duration-300 ease-in-out shadow-md">
                Generar Cita APA
            </button>
        </div>

        <div class="mt-8">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Cita Generada:</h2>
            <div id="citationOutput" class="bg-gray-50 p-4 rounded-md border border-gray-200 text-gray-800 text-sm break-words min-h-[80px] flex items-center justify-center text-center">
                La cita aparecerá aquí.
            </div>
            <button id="copyCitationBtn" class="w-full bg-green-600 text-white font-bold py-3 rounded-md hover:bg-green-700 transition duration-300 ease-in-out mt-4 shadow-md" style="display: none;">
                Copiar Cita
            </button>
            <div id="messageBox" class="mt-4 p-3 rounded-md text-sm text-center" style="display: none;"></div>
        </div>

        <hr class="my-8 border-gray-300">

        <!-- Nueva sección para Citas en el Texto -->
        <div class="space-y-4">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Generador de Citas en el Texto (Directas)</h2>
            <p class="text-gray-600 text-center mb-8">Introduce los detalles para generar el formato de cita directa en el texto (APA 7ª edición).</p>

            <div>
                <label for="inTextAuthorInput" class="block text-gray-700 text-sm font-semibold mb-2">Autor(es) - Apellido(s) (separa con punto y coma para múltiples autores):</label>
                <input type="text" id="inTextAuthorInput" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ej: García; Pérez; Smith">
            </div>
            <div>
                <label for="inTextYearInput" class="block text-gray-700 text-sm font-semibold mb-2">Año de Publicación:</label>
                <input type="number" id="inTextYearInput" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ej: 2023">
            </div>
            <div>
                <label for="inTextPageInput" class="block text-gray-700 text-sm font-semibold mb-2">Número(s) de Página/Párrafo (Ej: p. 1, pp. 1-5, párr. 3):</label>
                <input type="text" id="inTextPageInput" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ej: p. 42 o pp. 120-125 o párr. 3">
            </div>
            <div>
                <label for="inTextQuoteInput" class="block text-gray-700 text-sm font-semibold mb-2">Texto de la Cita Directa (opcional, para contexto):</label>
                <textarea id="inTextQuoteInput" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" rows="3" placeholder="Pega aquí el texto exacto que estás citando."></textarea>
            </div>

            <button id="generateInTextCitationBtn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-md hover:bg-blue-700 transition duration-300 ease-in-out shadow-md">
                Generar Cita en el Texto
            </button>
        </div>

        <div class="mt-8">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Cita en el Texto Generada:</h2>
            <div id="inTextCitationOutput" class="bg-gray-50 p-4 rounded-md border border-gray-200 text-gray-800 text-sm break-words min-h-[80px] flex items-center justify-center text-center">
                La cita en el texto aparecerá aquí.
            </div>
            <button id="copyInTextCitationBtn" class="w-full bg-green-600 text-white font-bold py-3 rounded-md hover:bg-green-700 transition duration-300 ease-in-out mt-4 shadow-md" style="display: none;">
                Copiar Cita en el Texto
            </button>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const documentTypeSelect = document.getElementById('documentType');
            const commonFieldsDiv = document.getElementById('commonFields');
            const websiteFieldsDiv = document.getElementById('websiteFields');
            const bookFieldsDiv = document.getElementById('bookFields');
            const journalArticleFieldsDiv = document.getElementById('journalArticleFields');

            const authorNameInput = document.getElementById('authorName');
            
            // Specific date/year inputs for full reference
            const publicationDateWebsiteInput = document.getElementById('publicationDateWebsite');
            const publicationYearBookInput = document.getElementById('publicationYearBook');
            // Removed month and day for book
            const publicationYearJournalInput = document.getElementById('publicationYearJournal');
            // Removed month and day for journal article

            // Website specific fields for full reference
            const articleTitleInput = document.getElementById('articleTitle');
            const websiteNameInput = document.getElementById('websiteName');
            const pageUrlInput = document.getElementById('pageUrl');

            // Book specific fields for full reference
            const bookTitleInput = document.getElementById('bookTitle');
            const publisherInput = document.getElementById('publisher');
            const isbnInput = document.getElementById('isbn');

            // Journal Article specific fields for full reference
            const journalArticleTitleInput = document.getElementById('journalArticleTitle');
            const journalNameInput = document.getElementById('journalName');
            const journalVolumeInput = document.getElementById('journalVolume');
            const journalIssueInput = document.getElementById('journalIssue');
            const pageRangeInput = document.getElementById('pageRange');
            const doiInput = document.getElementById('doi');

            const generateCitationBtn = document.getElementById('generateCitationBtn');
            const citationOutput = document.getElementById('citationOutput');
            const copyCitationBtn = document.getElementById('copyCitationBtn');
            const messageBox = document.getElementById('messageBox');

            // New elements for In-Text Citation Generator
            const inTextAuthorInput = document.getElementById('inTextAuthorInput');
            const inTextYearInput = document.getElementById('inTextYearInput');
            const inTextPageInput = document.getElementById('inTextPageInput');
            const inTextQuoteInput = document.getElementById('inTextQuoteInput');
            const generateInTextCitationBtn = document.getElementById('generateInTextCitationBtn');
            const inTextCitationOutput = document.getElementById('inTextCitationOutput');
            const copyInTextCitationBtn = document.getElementById('copyInTextCitationBtn');


            // Function to display temporary messages
            function showMessage(message, type = 'info') {
                messageBox.textContent = message;
                // Reset class to clear previous styling
                messageBox.className = 'mt-4 p-3 rounded-md text-sm text-center';
                if (type === 'success') {
                    messageBox.classList.add('bg-green-100', 'text-green-800');
                } else if (type === 'error') {
                    messageBox.classList.add('bg-red-100', 'text-red-800');
                } else { // info
                    messageBox.classList.add('bg-blue-100', 'text-blue-800');
                }
                messageBox.style.display = 'block'; // Ensure it's visible

                // Clear any previous timeout to ensure new messages are not hidden prematurely
                if (messageBox.timeoutId) {
                    clearTimeout(messageBox.timeoutId);
                }
                messageBox.timeoutId = setTimeout(() => {
                    messageBox.style.display = 'none';
                    messageBox.timeoutId = null; // Clear the ID after hiding
                }, 3000); // Hide after 3 seconds
            }

            // Function to format a date string to "Year, Day de Month" or "s.f."
            function formatDateForWebsite(dateString) {
                if (!dateString) return 's.f.'; // If no date, use s.f.
                const date = new Date(dateString + 'T00:00:00'); // Add T00:00:00 to avoid timezone issues
                if (isNaN(date.getTime())) return 's.f.'; // If date is invalid, use s.f.

                const year = date.getFullYear();
                const month = date.toLocaleDateString('es-ES', { month: 'long' });
                const day = date.getDate();

                return `${year}, ${day} de ${month}`; // Example: 2023, 20 de julio
            }

            // Helper function to format a single author name to "Lastname, F. M."
            function formatSingleAuthor(nameString) {
                if (!nameString) return '';

                // Normalize whitespace and convert to lowercase for consistent processing
                let cleanedName = nameString.trim().toLowerCase().replace(/\s+/g, ' ');

                let lastName = '';
                let firstNamesParts = [];

                if (cleanedName.includes(',')) {
                    // Assume format "Lastname, Firstname(s)"
                    const parts = cleanedName.split(',');
                    lastName = parts[0].trim();
                    firstNamesParts = parts.slice(1).join(' ').trim().split(' ');
                } else {
                    // Assume format "Lastname Firstname(s)" if no comma (based on APA convention for reference list)
                    const parts = cleanedName.split(' ');
                    if (parts.length > 1) {
                        lastName = parts[0].trim(); // First word is last name
                        firstNamesParts = parts.slice(1).map(part => part.trim()); // Rest are first/middle names
                    } else {
                        // If only one word, treat it as the last name with no first name initial
                        lastName = parts[0].trim();
                        firstNamesParts = [];
                    }
                }

                // Capitalize first letter of last name
                lastName = lastName.charAt(0).toUpperCase() + lastName.slice(1);

                // Get initials from first names parts
                let initials = '';
                if (firstNamesParts.length > 0 && firstNamesParts[0] !== '') {
                    initials = firstNamesParts.map(part => part.charAt(0).toUpperCase() + '.').join(' ');
                }

                return `${lastName}, ${initials}`;
            }

            // Function to format authors for the reference list according to APA 7th edition
            function formatAuthorsForReference(authorString) {
                if (!authorString) return '';

                // Split authors by semicolon, trim whitespace, and filter out empty strings
                const rawAuthors = authorString.split(';').map(a => a.trim()).filter(a => a !== '');

                // Format each individual author name using the helper function
                const formattedIndividualAuthors = rawAuthors.map(name => formatSingleAuthor(name));

                const numAuthors = formattedIndividualAuthors.length;

                if (numAuthors === 0) {
                    return '';
                } else if (numAuthors === 1) {
                    return formattedIndividualAuthors[0];
                } else if (numAuthors <= 20) {
                    // For 2 to 20 authors, list all, with '&' before the last
                    const lastAuthor = formattedIndividualAuthors.pop(); // Remove last author
                    return formattedIndividualAuthors.join(', ') + ' & ' + lastAuthor;
                } else {
                    // For 21 or more authors, list first 19, then '...', then the last author
                    const first19Authors = formattedIndividualAuthors.slice(0, 19).join(', ');
                    const lastAuthor = formattedIndividualAuthors[numAuthors - 1];
                    return first19Authors + ', ...., & ' + lastAuthor;
                }
            }

            // Function to format authors for in-text citation (Lastname, Lastname & Lastname, or Lastname et al.)
            function formatAuthorsForInTextCitation(authorString) {
                if (!authorString) return '';

                const rawAuthors = authorString.split(';').map(a => a.trim()).filter(a => a !== '');
                const numAuthors = rawAuthors.length;

                if (numAuthors === 0) {
                    return '';
                } else if (numAuthors === 1) {
                    // Just the last name
                    const parts = rawAuthors[0].split(',');
                    return parts[0].trim();
                } else if (numAuthors === 2) {
                    // Lastname & Lastname
                    const author1 = rawAuthors[0].split(',')[0].trim();
                    const author2 = rawAuthors[1].split(',')[0].trim();
                    return `${author1} & ${author2}`;
                } else {
                    // Lastname et al.
                    const firstAuthorLastName = rawAuthors[0].split(',')[0].trim();
                    return `${firstAuthorLastName} et al.`;
                }
            }


            // Function to format title for sentence case according to APA 7th edition
            function formatTitleForSentenceCase(titleString) {
                if (!titleString) return '';

                // Trim whitespace and convert to lowercase for initial processing
                let formattedTitle = titleString.trim().toLowerCase();

                // Capitalize the first letter of the entire title
                if (formattedTitle.length > 0) {
                    formattedTitle = formattedTitle.charAt(0).toUpperCase() + formattedTitle.slice(1);
                }

                // Handle subtitles (after a colon)
                const colonIndex = formattedTitle.indexOf(':');
                if (colonIndex !== -1 && colonIndex < formattedTitle.length - 1) {
                    // Capitalize the first letter after the colon and any leading space
                    let subtitlePart = formattedTitle.substring(colonIndex + 1).trim();
                    if (subtitlePart.length > 0) {
                        subtitlePart = subtitlePart.charAt(0).toUpperCase() + subtitlePart.slice(1);
                    }
                    formattedTitle = formattedTitle.substring(0, colonIndex + 1) + ' ' + subtitlePart;
                }

                // NOTA IMPORTANTE: Esta función capitaliza la primera letra del título y la primera letra después de un subtítulo.
                // NO capitaliza automáticamente nombres propios dentro del título (ej. "Estados Unidos", "Google").
                // El usuario debe asegurarse de que los nombres propios estén correctamente capitalizados en su entrada.
                return formattedTitle;
            }

            // Function to format text for Title Case (for website names, journal names)
            function formatForTitleCase(textString) {
                if (!textString) return '';

                return textString.split(' ').map(word => {
                    if (word.length === 0) return '';
                    // No capitalizar palabras menores (artículos, conjunciones, preposiciones cortas)
                    // a menos que sean la primera palabra de la frase.
                    const minorWords = new Set(['a', 'an', 'the', 'and', 'but', 'or', 'nor', 'at', 'by', 'for', 'from', 'in', 'into', 'of', 'on', 'to', 'with', 'y', 'o', 'con', 'sin', 'para', 'por', 'de', 'en', 'el', 'la', 'los', 'las', 'un', 'una', 'unos', 'unas']);
                    const lowerCaseWord = word.toLowerCase();

                    // Si es la primera palabra o no es una palabra menor, capitalizar.
                    // Se asume que la primera palabra de la frase siempre debe capitalizarse.
                    if (textString.indexOf(word) === 0 || !minorWords.has(lowerCaseWord)) {
                        return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
                    }
                    return lowerCaseWord;
                }).join(' ');
            }

            // Function to toggle visibility of fields based on document type
            function toggleFieldsVisibility() {
                const selectedType = documentTypeSelect.value;

                // Hide all specific fields first
                websiteFieldsDiv.classList.add('hidden');
                bookFieldsDiv.classList.add('hidden');
                journalArticleFieldsDiv.classList.add('hidden');

                // Clear all specific fields when switching type to avoid old data lingering
                publicationDateWebsiteInput.value = '';
                articleTitleInput.value = '';
                websiteNameInput.value = '';
                pageUrlInput.value = '';
                
                publicationYearBookInput.value = '';
                bookTitleInput.value = '';
                publisherInput.value = '';
                isbnInput.value = '';

                publicationYearJournalInput.value = '';
                journalArticleTitleInput.value = '';
                journalNameInput.value = '';
                journalVolumeInput.value = '';
                journalIssueInput.value = '';
                pageRangeInput.value = '';
                doiInput.value = '';
                
                // Also clear common author field, but it's not hidden
                authorNameInput.value = '';


                // Show fields based on selected type
                if (selectedType === 'website') {
                    websiteFieldsDiv.classList.remove('hidden');
                } else if (selectedType === 'book') {
                    bookFieldsDiv.classList.remove('hidden');
                } else if (selectedType === 'journalArticle') {
                    journalArticleFieldsDiv.classList.remove('hidden');
                }
            }

            // Initial call to set correct fields on load
            toggleFieldsVisibility();

            // Event listener for document type change
            documentTypeSelect.addEventListener('change', toggleFieldsVisibility);


            generateCitationBtn.addEventListener('click', () => {
                const docType = documentTypeSelect.value;
                const author = formatAuthorsForReference(authorNameInput.value.trim());
                let citation = '';
                let isValid = true;

                // Validation logic based on document type
                if (docType === 'website') {
                    const publicationDate = publicationDateWebsiteInput.value.trim();
                    const articleTitle = formatTitleForSentenceCase(articleTitleInput.value.trim());
                    const websiteName = formatForTitleCase(websiteNameInput.value.trim());
                    const pageUrl = pageUrlInput.value.trim();

                    // For websites, author is optional. Title, website name, and URL are mandatory.
                    if (!articleTitle || !websiteName || !pageUrl) {
                        showMessage('Para Página Web: rellena el Título del Artículo, Nombre del Sitio Web y URL.', 'error');
                        isValid = false;
                    } else {
                        const formattedPublicationDate = publicationDate ? `(${formatDateForWebsite(publicationDate)})` : '(s.f.)';
                        const currentDate = new Date();
                        const formattedRetrievalDate = currentDate.toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' });
                        
                        if (author) {
                            citation = `${author}. ${formattedPublicationDate}. <i>${articleTitle}</i>. ${websiteName}. Recuperado ${formattedRetrievalDate}, de ${pageUrl}`;
                        } else {
                            // If no author, title moves to author position and is NOT italicized.
                            citation = `${articleTitle}. ${formattedPublicationDate}. ${websiteName}. Recuperado ${formattedRetrievalDate}, de ${pageUrl}`;
                        }
                    }
                } else if (docType === 'book') {
                    const year = publicationYearBookInput.value.trim();
                    const bookTitle = formatTitleForSentenceCase(bookTitleInput.value.trim());
                    const publisher = publisherInput.value.trim();
                    const isbn = isbnInput.value.trim();

                    // For books, author, year, title, and publisher are mandatory.
                    if (!author || !year || !bookTitle || !publisher) {
                        showMessage('Para Libro: rellena el Autor, Año de Publicación, Título del Libro y Editorial.', 'error');
                        isValid = false;
                    } else {
                        // APA reference list for books typically only uses the year.
                        citation = `${author}. (${year}). <i>${bookTitle}</i>. ${publisher}.`;
                        if (isbn) {
                            citation += ` ISBN ${isbn}.`;
                        }
                    }
                } else if (docType === 'journalArticle') {
                    const year = publicationYearJournalInput.value.trim();
                    const journalArticleTitle = formatTitleForSentenceCase(journalArticleTitleInput.value.trim());
                    const journalName = formatForTitleCase(journalNameInput.value.trim());
                    const journalVolume = journalVolumeInput.value.trim();
                    const journalIssue = journalIssueInput.value.trim();
                    const pageRange = pageRangeInput.value.trim();
                    const doi = doiInput.value.trim();

                    // For journal articles, author, year, title, and journal name are mandatory.
                    // Volume, Issue, and Page Range are now optional.
                    if (!author || !year || !journalArticleTitle || !journalName) {
                        showMessage('Para Publicación o Artículo: rellena Autor, Año de Publicación, Título del Artículo y Nombre de la Publicación/Revista.', 'error');
                        isValid = false;
                    } else {
                        let issuePart = journalIssue ? `(${journalIssue})` : '';
                        let volumePart = journalVolume ? `<i>${journalVolume}</i>` : '';
                        let pagesPart = pageRange ? `, ${pageRange}` : ''; // Comma before page range if it exists
                        let doiUrl = '';

                        if (doi) {
                            let formattedDoi = doi.trim();
                            if (!formattedDoi.startsWith('http://') && !formattedDoi.startsWith('https://')) {
                                formattedDoi = `https://doi.org/${formattedDoi}`;
                            }
                            doiUrl = formattedDoi;
                        }

                        let journalDetails = `<i>${journalName}</i>`;
                        if (volumePart) {
                            journalDetails += `, ${volumePart}${issuePart}`;
                        } else if (journalIssue) { // If only issue is provided, APA usually needs volume. But if user provides, include it.
                            journalDetails += `, ${issuePart}`;
                        }
                        
                        journalDetails += `${pagesPart}`; // Add pages part
                        
                        citation = `${author}. (${year}). ${journalArticleTitle}. ${journalDetails}.`; 
                        if (doiUrl) {
                            citation += ` ${doiUrl}`;
                        }
                    }
                }

                if (!isValid) {
                    citationOutput.textContent = 'La cita aparecerá aquí.';
                    copyCitationBtn.style.display = 'none';
                    return;
                }

                citationOutput.innerHTML = citation; // Use innerHTML for italics
                copyCitationBtn.style.display = 'block';
                showMessage('Cita generada con éxito.', 'success');
            });

            copyCitationBtn.addEventListener('click', () => {
                const citationText = citationOutput.innerText; // Use innerText to copy only the text
                // Use document.execCommand('copy') for compatibility in iframes
                const textArea = document.createElement('textarea');
                textArea.value = citationText;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    showMessage('Cita copiada al portapapeles.', 'success');
                } catch (err) {
                    showMessage('Error al copiar la cita. Por favor, cópiala manualmente.', 'error');
                }
                document.body.removeChild(textArea);
            });

            // Logic for In-Text Citation Generator
            generateInTextCitationBtn.addEventListener('click', () => {
                const inTextAuthorString = inTextAuthorInput.value.trim();
                const inTextYear = inTextYearInput.value.trim();
                const inTextPage = inTextPageInput.value.trim();
                const inTextQuote = inTextQuoteInput.value.trim();

                let inTextCitation = '';
                let isValidInText = true;

                if (!inTextAuthorString || !inTextYear || !inTextPage) {
                    showMessage('Para la Cita en el Texto: rellena Autor(es), Año de Publicación y Número(s) de Página/Párrafo.', 'error');
                    isValidInText = false;
                }

                if (!isValidInText) {
                    inTextCitationOutput.textContent = 'La cita en el texto aparecerá aquí.';
                    copyInTextCitationBtn.style.display = 'none';
                    return;
                }

                const formattedInTextAuthors = formatAuthorsForInTextCitation(inTextAuthorString);
                const pageInfo = inTextPage ? `, ${inTextPage}` : '';

                // Parenthetical citation
                const parentheticalCitation = `(${formattedInTextAuthors}, ${inTextYear}${pageInfo})`;

                // Narrative citation
                const narrativeCitation = `${formattedInTextAuthors} (${inTextYear})${pageInfo}`;

                let quoteDisplay = '';
                if (inTextQuote) {
                    // Check if quote is 40 words or more for block quote formatting
                    const words = inTextQuote.split(/\s+/).filter(word => word.length > 0);
                    if (words.length >= 40) {
                        quoteDisplay = `
<p style="margin-left: 1.27cm; text-align: justify;">${inTextQuote}</p>
<p>${parentheticalCitation}</p>
                        `; // Removed text-align: right from parenthetical citation within block quote
                        inTextCitation = `<b>Cita en Bloque:</b><br>${quoteDisplay}<br><b>Ejemplo Narrativo:</b> ${narrativeCitation} comentó: "..." (ver cita en bloque).`;
                    } else {
                        quoteDisplay = `"${inTextQuote}"`;
                        inTextCitation = `<b>Ejemplo Parentético:</b> ${quoteDisplay} ${parentheticalCitation}<br><b>Ejemplo Narrativo:</b> ${narrativeCitation} afirmó: ${quoteDisplay}.`;
                    }
                } else {
                    inTextCitation = `<b>Ejemplo Parentético:</b> ${parentheticalCitation}<br><b>Ejemplo Narrativo:</b> ${formattedInTextAuthors} (${inTextYear})${pageInfo}`;
                }

                inTextCitationOutput.innerHTML = inTextCitation;
                copyInTextCitationBtn.style.display = 'block';
                showMessage('Cita en el texto generada con éxito.', 'success');
            });

            copyInTextCitationBtn.addEventListener('click', () => {
                const citationText = inTextCitationOutput.innerText; // Use innerText to copy only the text
                const textArea = document.createElement('textarea');
                textArea.value = citationText;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    showMessage('Cita en el texto copiada al portapapeles.', 'success');
                } catch (err) {
                    showMessage('Error al copiar la cita en el texto. Por favor, cópiala manualmente.', 'error');
                }
                document.body.removeChild(textArea);
            });
        });
    </script>
</body>
</html>