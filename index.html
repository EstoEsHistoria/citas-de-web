<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Citas APA por URL</title>
    <!-- Metadato de autor para esta página -->
    <meta name="author" content="Esto Es Historia">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Fuente Inter */
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(to right bottom, #e0f2fe, #bfdbfe); /* Degradado suave de fondo */
        }
        /* Estilos para el área de texto de la cita generada */
        #citationOutput {
            white-space: pre-wrap; /* Mantiene los saltos de línea y espacios */
            word-wrap: break-word; /* Rompe palabras largas para evitar desbordamiento */
            user-select: all; /* Permite seleccionar todo el texto fácilmente */
            min-height: 100px; /* Aumenta la altura mínima para visibilidad */
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 0.95rem; /* Ligeramente más grande */
            line-height: 1.5;
            color: #374151; /* Color de texto más oscuro */
            background-color: #f9fafb; /* Fondo muy claro */
            border: 1px solid #e5e7eb; /* Borde sutil */
            border-radius: 0.75rem; /* Bordes más redondeados */
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05); /* Sombra interna sutil */
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Mejoras para el contenedor principal */
        .main-container {
            background-color: #ffffff;
            padding: 2.5rem; /* Más padding */
            border-radius: 1.5rem; /* Más redondeado */
            box-shadow: 0 10px 25px rgba(0,0,0,0.1), 0 5px 10px rgba(0,0,0,0.05); /* Sombra más pronunciada */
            max-width: 600px; /* Ancho máximo para desktop */
            width: 100%;
            box-sizing: border-box; /* Asegura que padding no aumente el ancho */
        }

        /* Inputs mejorados */
        input[type="text"],
        input[type="date"],
        input[type="url"] {
            padding: 0.75rem 1rem; /* Más padding interno */
            border: 1px solid #d1d5db; /* Borde más definido */
            border-radius: 0.5rem; /* Bordes redondeados */
            transition: all 0.2s ease-in-out; /* Transición suave */
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.03); /* Sombra interna */
        }
        input[type="text"]:focus,
        input[type="date"]:focus,
        input[type="url"]:focus {
            border-color: #60a5fa; /* Borde azul al enfocar */
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.3); /* Anillo de enfoque azul */
            outline: none; /* Eliminar el contorno por defecto */
        }

        /* Botones mejorados */
        button {
            font-weight: 600; /* Semi-bold */
            padding: 0.85rem 1.5rem; /* Más padding */
            border-radius: 0.75rem; /* Más redondeado */
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); /* Sombra sutil */
        }
        button:hover {
            transform: translateY(-2px); /* Efecto de "levantamiento" al pasar el ratón */
            box-shadow: 0 6px 10px rgba(0,0,0,0.15); /* Sombra más grande al pasar el ratón */
        }
        #extractDataBtn {
            background: linear-gradient(to right, #3b82f6, #2563eb); /* Degradado azul */
            color: white;
        }
        #extractDataBtn:hover {
            background: linear-gradient(to right, #2563eb, #1d4ed8); /* Degradado más oscuro */
        }
        #generateCitationBtn {
            background: linear-gradient(to right, #10b981, #059669); /* Degradado verde */
            color: white;
        }
        #generateCitationBtn:hover {
            background: linear-gradient(to right, #059669, #047857); /* Degradado más oscuro */
        }
        #copyCitationBtn {
            background: linear-gradient(to right, #60a5fa, #3b82f6); /* Degradado azul claro */
            color: white;
        }
        #copyCitationBtn:hover {
            background: linear-gradient(to right, #3b82f6, #2563eb); /* Degradado más oscuro */
        }

        /* Mensajes de alerta */
        #messageBox {
            font-weight: 500;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            text-align: center;
        }
        .text-red-600 {
            color: #dc2626; /* Rojo más vibrante */
        }
        .text-gray-600 {
            color: #4b5563; /* Gris más oscuro para mejor contraste */
        }
        .text-gray-700 {
            color: #374151; /* Gris oscuro para etiquetas */
        }
        .text-gray-800 {
            color: #1f2937; /* Gris muy oscuro para títulos */
        }

        /* Responsividad general */
        @media (max-width: 768px) {
            .main-container {
                padding: 1.5rem; /* Menos padding en móviles */
                border-radius: 1rem; /* Menos redondeado en móviles */
            }
            h1 {
                font-size: 2rem; /* Título más pequeño en móviles */
            }
            p {
                font-size: 0.9rem; /* Texto más pequeño en móviles */
            }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div class="main-container"> <!-- Aplicamos la clase main-container aquí -->
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Generador de Citas APA por URL</h1>
        <p class="text-gray-600 text-center mb-8">Introduce una URL y la aplicación intentará obtener los datos para generar la cita APA (7ª edición).</p>
        <p class="text-red-600 text-sm mb-4">
            <strong>¡Importante!</strong> La extracción automática de datos de URLs externas a menudo falla debido a restricciones de seguridad del navegador (CORS).
            Si el botón "Obtener Datos" no funciona, por favor, rellena los campos manualmente.
        </p>

        <div class="space-y-4">
            <div>
                <label for="inputUrl" class="block text-gray-700 text-sm font-semibold mb-2">URL de la Página:</label>
                <input type="url" id="inputUrl" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ej: https://ejemplo.com/articulo">
            </div>

            <button id="extractDataBtn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-md hover:bg-blue-700 transition duration-300 ease-in-out shadow-md flex items-center justify-center">
                <span id="buttonText">Obtener Datos de la URL</span>
                <div id="loadingSpinner" class="spinner ml-2" style="display: none;"></div>
            </button>

            <hr class="my-6 border-gray-200">

            <!-- Campos para mostrar/editar los datos extraídos -->
            <div>
                <label for="authorName" class="block text-gray-700 text-sm font-semibold mb-2">Autor(es) (opcional) - Apellido, Iniciales. (separa con punto y coma para múltiples autores):</label>
                <input type="text" id="authorName" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ej: García, M. o García Manuel; Pérez, J.">
            </div>

            <div>
                <label for="publicationDate" class="block text-gray-700 text-sm font-semibold mb-2">Fecha de Publicación (opcional):</label>
                <input type="date" id="publicationDate" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>

            <div>
                <label for="articleTitle" class="block text-gray-700 text-sm font-semibold mb-2">Título del Artículo / Documento:</label>
                <input type="text" id="articleTitle" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ej: ¿Qué es civilización? Parte 1 - Civilización y cultura">
            </div>

            <div>
                <label for="websiteName" class="block text-gray-700 text-sm font-semibold mb-2">Nombre del Sitio Web:</label>
                <input type="text" id="websiteName" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ej: Wikipedia, BBC News, Esto Es Historia">
            </div>

            <button id="generateCitationBtn" class="w-full bg-green-600 text-white font-bold py-3 rounded-md hover:bg-green-700 transition duration-300 ease-in-out shadow-md">
                Generar Cita APA
            </button>
        </div>

        <div class="mt-8">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Cita Generada:</h2>
            <div id="citationOutput" class="bg-gray-50 p-4 rounded-md border border-gray-200 text-gray-800 text-sm break-words min-h-[80px] flex items-center justify-center text-center">
                La cita aparecerá aquí.
            </div>
            <button id="copyCitationBtn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-md hover:bg-blue-700 transition duration-300 ease-in-out mt-4 shadow-md" style="display: none;">
                Copiar Cita
            </button>
            <div id="messageBox" class="mt-4 p-3 rounded-md text-sm text-center" style="display: none;"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const inputUrl = document.getElementById('inputUrl');
            const extractDataBtn = document.getElementById('extractDataBtn');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const buttonText = document.getElementById('buttonText');

            const authorNameInput = document.getElementById('authorName');
            const articleTitleInput = document.getElementById('articleTitle');
            const publicationDateInput = document.getElementById('publicationDate');
            const websiteNameInput = document.getElementById('websiteName');
            const generateCitationBtn = document.getElementById('generateCitationBtn');
            const citationOutput = document.getElementById('citationOutput');
            const copyCitationBtn = document.getElementById('copyCitationBtn');
            const messageBox = document.getElementById('messageBox');

            // Function to display temporary messages
            function showMessage(message, type = 'info') {
                messageBox.textContent = message;
                messageBox.style.display = 'block';
                if (type === 'success') {
                    messageBox.className = 'mt-4 p-3 rounded-md text-sm text-center bg-green-100 text-green-800';
                } else if (type === 'error') {
                    messageBox.className = 'mt-4 p-3 rounded-md text-sm text-center bg-red-100 text-red-800';
                } else {
                    messageBox.className = 'mt-4 p-3 rounded-md text-sm text-center bg-blue-100 text-blue-800';
                }
                setTimeout(() => {
                    messageBox.style.display = 'none';
                }, 5000); // Hide after 5 seconds
            }

            // Function to format the date
            function formatDate(dateString) {
                if (!dateString) return 's.f.'; // If no date, use s.f.
                const date = new Date(dateString + 'T00:00:00'); // Add T00:00:00 to avoid timezone issues
                if (isNaN(date.getTime())) return 's.f.'; // If date is invalid, use s.f.

                const options = { day: 'numeric', month: 'long', year: 'numeric' };
                return date.toLocaleDateString('es-ES', options);
            }

            // Helper function to format a single author name to "Lastname, F. M."
            function formatSingleAuthor(nameString) {
                if (!nameString) return '';

                // Normalize whitespace and convert to lowercase for consistent processing
                let cleanedName = nameString.trim().toLowerCase().replace(/\s+/g, ' ');

                let lastName = '';
                let firstNamesParts = [];

                if (cleanedName.includes(',')) {
                    // Assume format "Lastname, Firstname(s)"
                    const parts = cleanedName.split(',');
                    lastName = parts[0].trim();
                    firstNamesParts = parts.slice(1).join(' ').trim().split(' ');
                } else {
                    // Assume format "Lastname Firstname(s)" if no comma (based on APA convention for reference list)
                    const parts = cleanedName.split(' ');
                    if (parts.length > 1) {
                        lastName = parts[0].trim(); // First word is last name
                        firstNamesParts = parts.slice(1).map(part => part.trim()); // Rest are first/middle names
                    } else {
                        // If only one word, treat it as the last name with no first name initial
                        lastName = parts[0].trim();
                        firstNamesParts = [];
                    }
                }

                // Capitalize first letter of last name
                lastName = lastName.charAt(0).toUpperCase() + lastName.slice(1);

                // Get initials from first names parts
                let initials = '';
                if (firstNamesParts.length > 0 && firstNamesParts[0] !== '') {
                    initials = firstNamesParts.map(part => part.charAt(0).toUpperCase() + '.').join(' ');
                }

                return `${lastName}, ${initials}`;
            }

            // Function to format authors for the reference list according to APA 7th edition
            function formatAuthorsForReference(authorString) {
                if (!authorString) return '';

                // Split authors by semicolon, trim whitespace, and filter out empty strings
                const rawAuthors = authorString.split(';').map(a => a.trim()).filter(a => a !== '');

                // Format each individual author name using the helper function
                const formattedIndividualAuthors = rawAuthors.map(name => formatSingleAuthor(name));

                const numAuthors = formattedIndividualAuthors.length;

                if (numAuthors === 0) {
                    return '';
                } else if (numAuthors === 1) {
                    return formattedIndividualAuthors[0];
                } else if (numAuthors <= 20) {
                    // For 2 to 20 authors, list all, with '&' before the last
                    const lastAuthor = formattedIndividualAuthors.pop(); // Remove last author
                    return formattedIndividualAuthors.join(', ') + ' & ' + lastAuthor;
                } else {
                    // For 21 or more authors, list first 19, then '...', then the last author
                    const first19Authors = formattedIndividualAuthors.slice(0, 19).join(', ');
                    const lastAuthor = formattedIndividualAuthors[numAuthors - 1];
                    return first19Authors + ', ...., & ' + lastAuthor;
                }
            }

            // Function to format title for sentence case according to APA 7th edition
            function formatTitleForSentenceCase(titleString) {
                if (!titleString) return '';

                // Trim whitespace and convert to lowercase for initial processing
                let formattedTitle = titleString.trim().toLowerCase();

                // Capitalize the first letter of the entire title
                if (formattedTitle.length > 0) {
                    formattedTitle = formattedTitle.charAt(0).toUpperCase() + formattedTitle.slice(1);
                }

                // Handle subtitles (after a colon)
                const colonIndex = formattedTitle.indexOf(':');
                if (colonIndex !== -1 && colonIndex < formattedTitle.length - 1) {
                    // Capitalize the first letter after the colon and any leading space
                    let subtitlePart = formattedTitle.substring(colonIndex + 1).trim();
                    if (subtitlePart.length > 0) {
                        subtitlePart = subtitlePart.charAt(0).toUpperCase() + subtitlePart.slice(1);
                    }
                    formattedTitle = formattedTitle.substring(0, colonIndex + 1) + ' ' + subtitlePart;
                }

                // Note: This function does not automatically capitalize proper nouns within the title.
                // Users should ensure proper nouns are capitalized in their input.

                return formattedTitle;
            }

            // Function to format text for Title Case (for website names)
            function formatForTitleCase(textString) {
                if (!textString) return '';

                return textString.split(' ').map(word => {
                    if (word.length === 0) return '';
                    // Do not capitalize minor words like "a", "an", "the", "and", "but", "or", "nor", "at", "by", "for", "from", "in", "into", "of", "on", "to", "with"
                    // unless they are the first word. This is a simplified list.
                    const minorWords = new Set(['a', 'an', 'the', 'and', 'but', 'or', 'nor', 'at', 'by', 'for', 'from', 'in', 'into', 'of', 'on', 'to', 'with']);
                    const lowerCaseWord = word.toLowerCase();

                    if (minorWords.has(lowerCaseWord) && textString.indexOf(word) !== 0) {
                        return lowerCaseWord;
                    }
                    return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
                }).join(' ');
            }

            // Function to extract metadata from a parsed HTML document
            function extractMetadata(doc) {
                let title = doc.querySelector('title')?.textContent || '';
                let author = '';
                let websiteName = '';
                let publicationDate = '';

                // Try to get author from meta tags
                const authorMeta = doc.querySelector('meta[name="author"]') ||
                                   doc.querySelector('meta[property="author"]') ||
                                   doc.querySelector('meta[property="article:author"]');
                if (authorMeta) {
                    author = authorMeta.getAttribute('content');
                }

                // Try to get website name from og:site_name or fallback to hostname
                const ogSiteNameMeta = doc.querySelector('meta[property="og:site_name"]'); // Corrected property name
                if (ogSiteNameMeta) {
                    websiteName = ogSiteNameMeta.getAttribute('content');
                } else if (inputUrl.value) {
                    try {
                        const urlObj = new URL(inputUrl.value);
                        websiteName = urlObj.hostname.replace('www.', '');
                        // Capitalize the first letter of each part of the hostname
                        websiteName = websiteName.split('.').map(part => part.charAt(0).toUpperCase() + part.slice(1)).join('.');
                    } catch (e) {
                        // Invalid URL, websiteName remains empty or as provided
                    }
                }

                // Try to get publication date from meta tags
                const pubDateMeta = doc.querySelector('meta[property="article:published_time"]') ||
                                    doc.querySelector('meta[name="pubdate"]') ||
                                    doc.querySelector('meta[name="date"]'); // Less common for pub date
                if (pubDateMeta) {
                    publicationDate = pubDateMeta.getAttribute('content');
                    // Attempt to parse to YYYY-MM-DD if it's a full date string
                    try {
                        const date = new Date(publicationDate);
                        if (!isNaN(date.getTime())) {
                            publicationDate = date.toISOString().split('T')[0]; // Format to YYYY-MM-DD
                        } else {
                            publicationDate = ''; // If parsing fails, clear it
                        }
                    } catch (e) {
                        publicationDate = '';
                    }
                }

                // Fallback for title if meta title is empty
                if (!title) {
                    const ogTitleMeta = doc.querySelector('meta[property="og:title"]');
                    if (ogTitleMeta) {
                        title = ogTitleMeta.getAttribute('content');
                    }
                }

                return { title, author, websiteName, publicationDate };
            }

            extractDataBtn.addEventListener('click', async () => {
                const url = inputUrl.value.trim();
                if (!url) {
                    showMessage('Por favor, introduce una URL.', 'error');
                    return;
                }

                // Reset fields and show loading
                authorNameInput.value = '';
                articleTitleInput.value = '';
                publicationDateInput.value = '';
                websiteNameInput.value = '';
                citationOutput.textContent = 'La cita aparecerá aquí.';
                copyCitationBtn.style.display = 'none';
                loadingSpinner.style.display = 'block';
                buttonText.textContent = 'Obteniendo...';
                extractDataBtn.disabled = true;

                try {
                    // The `fetch` request will likely be blocked by CORS for most external sites.
                    // This is a browser security feature and cannot be bypassed client-side.
                    // A server-side proxy would be needed for reliable cross-origin fetching.
                    const response = await fetch(url);

                    if (!response.ok) {
                        throw new Error(`Error HTTP: ${response.status} - ${response.statusText}`);
                    }

                    const htmlText = await response.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(htmlText, 'text/html');

                    const extracted = extractMetadata(doc);

                    articleTitleInput.value = extracted.title;
                    authorNameInput.value = extracted.author;
                    publicationDateInput.value = extracted.publicationDate;
                    websiteNameInput.value = extracted.websiteName;

                    showMessage('Datos obtenidos (revisa y edita si es necesario).', 'success');

                } catch (error) {
                    console.error('Error al obtener o parsear la URL:', error);
                    let errorMessage = 'Error al obtener los datos de la URL.';
                    if (error.message.includes('CORS') || error.name === 'TypeError' && error.message.includes('network')) {
                        errorMessage += ' Esto suele deberse a restricciones de seguridad del navegador (CORS). Por favor, rellena los campos manualmente.';
                    } else if (error.message.includes('HTTP')) {
                        errorMessage = `Error HTTP ${error.message.split('-')[0].trim()}. Por favor, verifica la URL.`;
                    }
                    showMessage(errorMessage, 'error'); // Aseguramos que el tipo sea 'error'
                } finally {
                    loadingSpinner.style.display = 'none';
                    buttonText.textContent = 'Obtener Datos de la URL';
                    extractDataBtn.disabled = false;
                }
            });

            generateCitationBtn.addEventListener('click', () => {
                const rawAuthorName = authorNameInput.value.trim();
                const rawArticleTitle = articleTitleInput.value.trim();
                const publicationDate = publicationDateInput.value;
                const rawWebsiteName = websiteNameInput.value.trim();
                const pageUrl = inputUrl.value.trim(); // Use the URL from the input field

                // Validate required fields
                if (!rawArticleTitle || !rawWebsiteName || !pageUrl) {
                    showMessage('Por favor, rellena el Título, el Nombre del Sitio Web y la URL.', 'error');
                    citationOutput.textContent = 'La cita aparecerá aquí.';
                    copyCitationBtn.style.display = 'none';
                    return;
                }

                const formattedPublicationDate = formatDate(publicationDate);
                const currentDate = new Date();
                const formattedRetrievalDate = currentDate.toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' });

                let citation = '';
                const formattedAuthor = formatAuthorsForReference(rawAuthorName);
                const formattedArticleTitle = formatTitleForSentenceCase(rawArticleTitle);
                const formattedWebsiteName = formatForTitleCase(rawWebsiteName);

                if (formattedAuthor) {
                    citation = `${formattedAuthor}. (${formattedPublicationDate}). <i>${formattedArticleTitle}</i>. ${formattedWebsiteName}. Recuperado ${formattedRetrievalDate}, de ${pageUrl}`;
                } else {
                    citation = `<i>${formattedArticleTitle}</i>. (${formattedPublicationDate}). ${formattedWebsiteName}. Recuperado ${formattedRetrievalDate}, de ${pageUrl}`;
                }

                citationOutput.innerHTML = citation;
                copyCitationBtn.style.display = 'block';
                showMessage('Cita generada con éxito.', 'success');
            });

            copyCitationBtn.addEventListener('click', () => {
                const citationText = citationOutput.innerText;
                const textArea = document.createElement('textarea');
                textArea.value = citationText;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    showMessage('Cita copiada al portapapeles.', 'success');
                } catch (err) {
                    showMessage('Error al copiar la cita. Por favor, cópiala manualmente.', 'error');
                }
                document.body.removeChild(textArea);
            });
        });
    </script>
</body>
</html>
